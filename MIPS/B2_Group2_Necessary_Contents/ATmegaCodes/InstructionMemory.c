#include <avr/io.h>
#define F_CPU 1000000
#include <util/delay.h>

unsigned int instructionMemory[256]={
	0x9015,0x9023,0x9037,0x9042,0x9054,0x2123,0x1345,0x8553,0x6222,0x7333,0x3232,0xf320,0x5340,0xd080,0x5252,0x6221,
	0x0331,0x9000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
	0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
	0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
	0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
	0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
	0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
	0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
	0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
	0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
	0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
	0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
	0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
	0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
	0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
	0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000};

int regDst;
unsigned char regDstOutput;

int main(void)
{	
	//Taking pc in through PORTB
	//Instruction out through PORTA and PORTC
	DDRA=0XFF; //40->33 0->7
	DDRB=0x00;
	DDRC=0xFF; //22-29 8-15
	DDRD=0x0F; //MSB four for register file destination register output, LSB 4 for control flag inputs
	
	MCUCSR|=(1<<JTD);
	MCUCSR|=(1<<JTD);
	
	unsigned int pc = 0x00;
	int clkcnt = 0;
	unsigned char g = 0b00000000;

	while (1) {
		unsigned char c ;
		pc = PINB;
		c = (instructionMemory[pc]&0xFF)&(0xff);	//Lower 8 bits
		PORTA = c;
		c = ((instructionMemory[pc])>>8)&(0xff);	//Higher 8 bits
		PORTC = c;

        //Control flags
        regDst = (PIND & 0b00010000) >> 4;

        if(regDst == 1){
            regDstOutput = (instructionMemory[pc] & 0x0F) & 0x0F;
        }
        else{
            regDstOutput = ( (instructionMemory[pc]>>4 ) & 0x0F) & 0x0F;
        }

		// //For auto clock -> not necessary
		// clkcnt++;
		// if(clkcnt==100){
		// 	clkcnt = 0;
		// 	if(g==0x00000000) g = 0b10000000;
		// 	else g = 0b00000000;
		// 	PORTD = g;
		// }
		
		// _delay_ms(10);
		// //For auto clock -> not necessary

        PORTD = (PORTD & 0xF0) | (regDstOutput);

	}
}

//15->0
//15->8 green->red
//7->yellow, 6->orange
//5-0 green->black